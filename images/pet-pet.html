<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pet Pet Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jimp/0.16.1/jimp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; max-width: 500px; width: 100%; }
        
        .input-group { margin-bottom: 15px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 10px; }
        
        #output { margin-top: 20px; border: 2px dashed #ccc; min-height: 150px; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        img { max-width: 100%; }
        
        button { padding: 12px 24px; cursor: pointer; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; transition: background 0.2s; width: 100%; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .error { color: red; font-size: 0.9em; margin-top: 10px; display: none; background: #ffe6e6; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Pet Pet Generator</h2>

    <div class="input-group">
        <label>Option 1: Upload Image</label>
        <input type="file" id="fileInput" accept="image/*">
        
        <div style="margin: 10px 0; text-align: center; color: #888;">- OR -</div>

        <label>Option 2: Image URL</label>
        <input type="text" id="urlInput" placeholder="https://example.com/image.png" value="https://files.catbox.moe/rxoiny.jpg">
        <small style="color: #666;">Note: External URLs must allow CORS.</small>
    </div>

    <button onclick="generateGif()" id="btn">Generate GIF</button>
    
    <p id="status">Ready</p>
    
    <p id="errorMsg" class="error"></p>
    
    <div id="output">
        <span style="color:#aaa">Result will appear here</span>
    </div>
</div>

<script>
    async function generateGif() {
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const outputDiv = document.getElementById('output');
        const errorMsg = document.getElementById('errorMsg');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');
        btn.disabled = true;
        if (errorMsg) errorMsg.style.display = 'none';
        outputDiv.innerHTML = '';
        status.innerText = "Initializing...";

        try {
            status.innerText = "Loading GIF worker...";
            const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js';
            const response = await fetch(workerUrl);
            if (!response.ok) throw new Error("Could not load worker script");
            const workerScriptText = await response.text();
            
            const workerBlob = new Blob([workerScriptText], { type: 'application/javascript' });
            const localWorkerUrl = URL.createObjectURL(workerBlob);
            let avatarSource;
            if (fileInput.files && fileInput.files[0]) {
                status.innerText = "Reading uploaded file...";
                avatarSource = await fileInput.files[0].arrayBuffer();
            } else if (urlInput.value.trim() !== "") {
                avatarSource = urlInput.value.trim();
            } else {
                throw new Error("Please upload an image or provide a URL.");
            }

            status.innerText = "Loading avatar image...";
            const originalAvatar = await Jimp.read(avatarSource).catch(err => {
                throw new Error("Could not load image. If using a URL, the site might block access (CORS). Try uploading the file instead.");
            });

            const size = 128;
            const frames = 10;
            const hand_images = [
                'https://i.imgur.com/fQSSB1c.gif',
                'https://i.imgur.com/H4BJb3E.gif',
                'https://i.imgur.com/L9nkOq8.gif',
                'https://i.imgur.com/JbroDue.gif',
                'https://i.imgur.com/HYhtsrQ.gif',
                'https://i.imgur.com/qRMyaoG.gif',
                'https://i.imgur.com/Vqc6XIf.gif',
                'https://i.imgur.com/tziFtAT.gif',
                'https://i.imgur.com/NertTfu.gif',
                'https://i.imgur.com/782ZYfg.gif',
            ];

            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: size,
                height: size,
                transparent: 0x00000000,
                workerScript: localWorkerUrl 
            });

            for (let i = 0; i < frames; i++) {
                status.innerText = `Processing frame ${i + 1}/${frames}...`;
                await new Promise(r => setTimeout(r, 10));

                const j = i < frames / 2 ? i : frames - i;
                const width = 0.8 + j * 0.02;
                const height = 0.8 - j * 0.05;
                const offsetX = (1 - width) * 0.5 + 0.1;
                const offsetY = 1 - height - 0.08;

                let base = new Jimp(size, size);
                let avatar = originalAvatar.clone();
                let handImage = await Jimp.read(hand_images[i]);

                avatar.circle();
                avatar.resize(size * width, size * height);
                base.composite(avatar, offsetX * size, offsetY * size);
                base.composite(handImage, 0, 0);

                const p = base.bitmap;
                const data = new Uint8ClampedArray(p.data);
                const imageData = new ImageData(data, p.width, p.height);

                gif.addFrame(imageData, { delay: 25 });
            }

            status.innerText = "Rendering GIF...";
            gif.on('finished', function(blob) {
                const resultImg = document.createElement('img');
                resultImg.src = URL.createObjectURL(blob);
                outputDiv.appendChild(resultImg);
                status.innerText = "Done! Right-click image to save.";
                btn.disabled = false;
                URL.revokeObjectURL(localWorkerUrl);
            });

            gif.render();

        } catch (err) {
            console.error(err);
            if(errorMsg) {
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.style.display = 'block';
            } else {
                alert("Error: " + err.message);
            }
            status.innerText = "Failed.";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>